============================= test session starts ==============================
platform darwin -- Python 3.13.1, pytest-8.3.5, pluggy-1.6.0
rootdir: /Users/stephenng/programming/blockwords/cubes
collected 2 items

tests/integration/test_sequential_start.py .F                            [100%]

=================================== FAILURES ===================================
_____________________________ test_p1_starts_first _____________________________

    @async_test
    async def test_p1_starts_first():
        """Test P1 starting first, then P0 joins."""
        game, mqtt, queue = await create_test_game(descent_mode="discrete")
        now_ms = reset_abc_test_state(game)
    
        # Initialize cubes
        await setup_abc_test(game, mqtt, queue, [["1", "2", "3"], ["11", "12", "13"]], now_ms)
    
        # --- Start P1 ---
        # P1 forms A-B-C: 11->12->13
        await inject_neighbor_report(mqtt, "11", "12")
        await inject_neighbor_report(mqtt, "12", "13")
    
        await process_mqtt_queue(game, queue, mqtt, now_ms)
        await advance_frames(game, queue, frames=ABC_COUNTDOWN_FRAMES)
    
        # Verify P1 started
        assert game.running
        assert_player_started(game, player=1)
    
        # Verify P0 NOT started
        assert not cubes_to_game.has_player_started_game(0)
    
        # --- Start P0 ---
        # P0 forms A-B-C: 1->2->3
        await inject_neighbor_report(mqtt, "1", "2")
        await inject_neighbor_report(mqtt, "2", "3")
    
        await process_mqtt_queue(game, queue, mqtt, now_ms)
        await advance_frames(game, queue, frames=ABC_COUNTDOWN_FRAMES)
    
        # Verify P0 started
        assert_player_started(game, player=0)
        assert len(game.racks[0].tiles) > 0 # Display racks (checking visibility)
    
        # Independence check
        # P1 hasn't played, P0 joined. Racks should match start state (Shared Start).
>       assert game._app._player_racks[0].get_tiles() == game._app._player_racks[1].get_tiles()
E       AssertionError: assert [Tile(letter=...='Y', id='5')] == [Tile(letter=...='G', id='2')]
E         
E         At index 0 diff: Tile(letter='A', id='0') != Tile(letter='L', id='3')
E         Use -v to get more diff

tests/integration/test_sequential_start.py:146: AssertionError
----------------------------- Captured stdout call -----------------------------
starting from callback for player 1
Starting cubes for player 1 with input device: player_1
self.running: True, False, ['player_0']
starting second player with input_device: player_1, ['player_0']
Starting cubes for player 1 with input device: player_1
0 starting new game with input_device: player_1
ADDED player_1 in self.input_devices: True
start_cubes: starting letter 0
>>>>>>>> app.STARTING
initial bingo: ---------- GALAXY --------
>>>>>>>> app.STARTED
start done
=============================== warnings summary ===============================
../../../../../Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/pygame/pkgdata.py:25
  /Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/pygame/pkgdata.py:25: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
    from pkg_resources import resource_stream, resource_exists

../../../../../Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/pkg_resources/__init__.py:3142
../../../../../Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/pkg_resources/__init__.py:3142
  /Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/pkg_resources/__init__.py:3142: DeprecationWarning: Deprecated call to `pkg_resources.declare_namespace('zope')`.
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    declare_namespace(pkg)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/integration/test_sequential_start.py::test_p1_starts_first - Ass...
=================== 1 failed, 1 passed, 3 warnings in 1.71s ====================
